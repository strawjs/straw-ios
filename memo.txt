

plugin -> service


straw-ios-http-service
straw-ios-http-service.js

/**
 * STWServiceCall is the model class of the Service Method call from Browser.
 *
 * @layer Domain
 */
@interface STWServiceCall : NSObject

@property (nonatomic, retain) NSNumber *callId;
@property (nonatomic, retain) NSString *service;
@property (nonatomic, retain) NSString *method;
@property (nonatomic, retain) BOOL *success;

@end



/**
 * STWServiceCallFactory is the factory class of STWServiceCall objects.
 *
 * @layer Domain
 */
@interface STWServiceCallFactory : NSObject
+ (STWServiceCall *)createFromJSON:(JSONObject *)json;
@end

/**
 * STWService is the protocol conformed by Straw Service implementations.
 *
 * @layer Domain
 */
@protocol STWService <NSObject>

- actionCall:(STWCall *)call;

@end

/**
 * STWServiceCallContext is a context of a single Service Method call.
 * Service authers can succeed or fail Service Method Call using this class.
 *
 * @layer Application
 */
@protocol STWServiceCallContext <NSObject>

@property (nonatomic, assign, readonly) UIViewController *viewController
@property (nonatomic, assign, readonly) UIWebView *webView;
@property (nonatomic, retain, readonly) STWServiceCall *call;

- (void)succeed;
- (void)succeedWithString:(NSString *)value;
- (void)succeedWithNumber:(NSNumber *)value;
- (void)succeedWithJSON:(JSONObject *)value;

- (void)failWithCode:(NSNumber *)code withMessage:(NSString *)message;

@end

/**
 * STWServiceRepository is the repository class of id <STWService>.
 *
 * @layer Domain
 */
@interface STWServiceRepository : NSObject

@property (nonatomic, retain, readonly)
@end


/**
 * ExampleService is a example of Service implementation
 *
 * @layer Service
 */
@interface ExampleService <StrawService> : NSObject
- (void)action:(JSONObject *)params withContext:(STWServiceContext *)context;
@end

@implementation ExampleService
- (void)action:(JSONObject *)arg withContext:(STWServiceCallContext *)context {
    if ([self blah]) {
        [context succeed];

    } else if ([self blahblah]) {
        [context succeedWithObject:@{@"a": @123}];

    } else {
        [call failWithCode:@123 withMessage:@"example failed!"];
    }
}
@end


- (void)callService:(id <STWService>)service withContext(id <STWServiceCallContext>)context
{
    STWServiceCall *call = context.serviceCall;

    // Service Method must have the form of
    // `- (void)methodName:(NSDcitionary *)params withCall:(id <STWServiceCallContext>)`
    NSString *methodName = [NSString stringWithFormat:@"%@:withContext:", call.method];

    // create the selector for Service Method
    SEL selector = NSSelectorFromString(methodName);

    if ([service respondsToSelector:selector]) {

#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Warc-performSelector-leaks"

        // invoke Service Method
        [service performSelector:selector withObject:call.params withObject:context];

#pragma clang diagnostic pop

    } else {
        // TODO: log error
    }
}

@interface STWNativeWebViewBridge : NSObject

+ (NSString *)createNativeToBrowserMessage:(NSDictionary *)params;
+ (NSString *)retrieveRequestObjectForCallId:(NSString *)callId;

@end

A service can be either stateful or stateless.
That's why the naming of `Straw Service Method`.
Reusable services should be most likely stateless.
Application specific services can be stateful.


Service - a bundle of series of functions.
Service Method - a functionality of a service.
Service Call - a call of Service Method.
Service Call Context - a context of a call of Service Method

Service Repository - repository of services
Service Call Factory - factory of service call object

----

The Domain Services should never touch the Application layer.
(But specific service implementations can touch the application layey,
because they are half-application.)

Do people really want stateful services?

----

TODO:
- .podspec of straw-ios

- infra
  - straw service registry
    - mongodb, heroku

- http service
  - straw-ios-http-service

- hud servcie (corresponding to toast service of straw-android)
  - based on MPProgressHUD

- kvdb service (corresponding to sharedPreferences service of straw-android)
  - based on https://github.com/colinyoung/kvdb

- log servcie
  - log on each level

- STWWebView, STWViewController (in Wrapper group)

- whatsmyip-ios
  - implement existing feature
  - add some achievements

- refactor straw-android completely
  - separate domain and application according to straw-ios
    - remove StrawDrink and instead of that create StrawCallContext interface and StrawCallOperation class (which implements StrawCallContext)
  - rename `plugin` to `service`

- next application!

DONE:
- LogError on call factory failures. - done
- implementation - done
- tests - done
- define interfaces - almost done
- build on xcode 5.1
- STWServiceFactory
- log - done

[END]
